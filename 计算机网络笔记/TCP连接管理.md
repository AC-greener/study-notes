### TCP连接

1. 几乎所有的http通信都是由tcp/ip承载的，tcp/ip是一种常用的分组交换网络分层协议集
2. tcp是可靠连接，他为http提供了一条可靠的比特传输管道，从连接一段填入的字节会从另外一段按原本的顺序正确的传送出来
3. tcp流是分段传输的。http会以流的形式将报文内容通过一条tcp连接按序传输，tcp收到数据流之后会把数据流砍成被称作段小数据块，然后封装在ip分组中进行传输。每个tcp段都是由ip分组承载，每个ip分组包括：
   1. 一个ip分组首部
   2. 一个tcp段首部
   3. 一个tcp数据块

### TCP性能

1. http事务的时延
   1. 根据url进行dns查询
   2. 建立tcp连接请求，每个新的tcp连接都会有连接时延，这个值最多有一两秒，但是当http事务多的话，该值很快会增大
   3. 服务器处理请求报文所花的时间
   4. 服务器返回http响应的时间
2. tcp相关时延
   1. **tcp连接的握手时延**，每进行一次tcp连接都要进行握手，如果连接只用来传递少量的数据，那么这些握手过程就会严重降低http性能
   2. **延迟确认**，每个tcp段都有一个序列号和数据校验和。每个段的接收者收到完好的段，都会向发送者回送小的确认分组。如果发送者指定的时间内没有收到确认信息，发送者就会认为分组被破坏或损毁，并重发数据
   3. **tcp慢启动，**tcp连接会随着时间进行自我调谐，起初会限制连接的最大速度，如果数据传输成功，会随着时间的推移提高传输速度。可以防止因特网突然过载和拥塞。

### http连接管理

1. 串行事务处理时延太高
2. **并行连接，**http允许客户端打开多条链接，并行的执行多个http事务。缺点：
   1. 每个事务都会打开一条新的连接，会耗费时间和带宽
   2. 由于慢启动特性的存在，每条新的连接性能都会有所降低
   3. 可打开的并行数量有限
3. **持久连接，**在http事务处理结束之后仍然保持在打开状态的tcp连接被称为持久连接。非持久连接会在食物结束之后关闭。持久连接会在不同事物之间保持打开状态，直到客户端或服务器决定将其关闭为止。
   1. 持久连接降低了连接建立的开销，将链接保持在已调谐状态。但是管理持久连接要小心一点，不然就会积累大量的空闲连接。
   2. 持久连接分为两种：http1.0+keep-alive，以及http1.1的 persistent连接
      1. http1.0可以通过connection: keep-alive首部请求将一条连接保持在打开状态，响应中如果没有connection: keep-alive，客户端就认为服务器不支持keep-alive，会在发挥响应报文之后关闭连接
      2. keep-alive响应首部： keep-alive： max=5，timeout=120
      3. http1.0 keep-alive不是默认启动的，需要主动请求
      4. http1.1用一种名为持久连接（persistent）的设计取代了它。默认是开启的，以以前的版本中leep-alive要么是可选的，要么就不支持
4. **管道化连接，**http1.1允许在持久连接上可选的使用请求管道，也就是说在响应到达之前，可以将多条请求放入队列。对管道还连接的限制：
   1. 如果客户端无法确认链接是持久的。就不能使用管道
   2. 必须按照和请求相同的顺序返回响应，因为http报文中没有序列号标签
   3. 客户端必须做好连接会在任意时刻关闭的准备，还要重发所有未完成的管道化请求